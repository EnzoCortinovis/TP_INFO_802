<!DOCTYPE html>
<html>
<title>TP INFO802</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link rel="preconnect" href="https://fonts.gstatic.com">
<script src="https://kit.fontawesome.com/ab2155e76b.js" crossorigin="anonymous"></script>
<style>

h1,h2,h3,h4,h5,h6 {font-family: "Oswald"}
body {font-family: "Open Sans"}

#googleMap {
  width: 80%;
  height: 700px;
  margin: 10px auto;
}

/*        CSS POUR LISTE DÉROULANTE         */

@import url(https://fonts.googleapis.com/css?family=Raleway);
body{
  font-family: 'Raleway', sans-serif;
  background:#3E4651;
}
.list-choice{
  width:300px;
  margin:1em auto;
  position: relative;
  cursor: pointer;  
}
.list-choice input[type="radio"]{
  position:absolute;
  left:-9999px;
}

.list-choice-title {
width: 100%;
display: block;
background: #D8D8D8;
text-align: center;
padding: 0.55em 1em;
box-sizing: border-box;
color: #FFF;
text-shadow: 0 1px 0 #CACACA;
border-radius: 0.2em;
}
.list-choice:hover .list-choice-title {
border-radius:0.2em 0.2em 0 0;
}
.list-choice-objects label:nth-last-of-type(1) span{
  border-radius:0 0 0.2em 0.2em;
}
.list-choice input[type="radio"] + span {
color: #FFF;
background: #D8D8D8;
padding: 0.55em 1em;
display: block;
text-align: center;
box-sizing: border-box;
cursor: pointer;
width: 100%;
}
.list-choice-objects {
position: absolute;
top: 0;
padding-top: 2.1em;
box-sizing: border-box;
width: 100%;
overflow: hidden;
max-height: 0;
transition: all 250ms ease;
}
.list-choice:hover .list-choice-objects  input[type="radio"] + span {
position: relative;
top: 0;
transition: all 250ms ease-in-out;
}
.list-choice:hover input[type="radio"] + span:hover {
background:#BBB;
}
.list-choice:hover input[type="radio"]:checked + span:hover {
background:#74D68E;
}
.list-choice input[type="radio"]:checked + span {
background: #74D68E;
position: absolute;
top: 0em;
border-radius: 0.2em;
}
.list-choice:hover input[type="radio"]:checked + span {
border-radius: 0;
}
.list-choice:hover .list-choice-objects label:nth-last-of-type(1) input[type="radio"]:checked + span{
  border-radius:0 0 0.2em 0.2em;
}

.list-choice:hover .list-choice-objects {
max-height: 540px;
}


</style>

<body class="w3-light-grey">

<!-- Navigation bar with social media icons -->
<div class="w3-bar w3-black w3-hide-small">
  <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" class="w3-bar-item w3-button"><i class="fa fa-instagram"></i></a>
  <a href="https://www.youtube.com/watch?v=YgT6XABqS5Y" class="w3-bar-item w3-button"><i class="fa fa-snapchat"></i></a>
  <a href="https://twitter.com/CortinovisEnzo" class="w3-bar-item w3-button"><i class="fa fa-twitter"></i></a>
  <a href="https://www.linkedin.com/in/enzo-cortinovis-635a6022a/" class="w3-bar-item w3-button"><i class="fa fa-linkedin"></i></a>
  <a href="#" class="w3-bar-item w3-button w3-right"><i class="fa fa-search"></i></a>
</div>
  
<!-- w3-content defines a container for fixed size centered content, 
and is wrapped around the whole page content, except for the footer in this example -->
<div class="w3-content" style="max-width:1600px">

  <!-- Header -->
  <header class="w3-container w3-center w3-padding-48 w3-white">
    <h1 class="w3-xxxlarge"><b>TP INFO802</b></h1>
    <h6>Bienvenu sur le projet tp de <span class="w3-tag">Enzo Cortinovis</span></h6>
    <p></p>
    <h2><label for="cars-select" >Choisissez un modèle de voiture électrique</label></h2>
    
    <div class="list-choice">                         <!--  Affichage serveur Soap  -->
      <div class="list-choice-title">Voiture</div>
      <div class="list-choice-objects">
        <label>
          <input type="radio" name="month" oninput="myFunction('1')"/><span>Dacia Spring</span>
        </label>
        <label>
          <input type="radio" name="month" oninput="myFunction('2')"/><span>Tesla Y</span>
        </label>
        <label>
          <input type="radio" name="month" oninput="myFunction('3')"/><span>Renault Zoe</span>
        </label>
        <label>
          <input type="radio" name="month" oninput="myFunction('4')"/><span>Hyundai Ioniq 5</span>
        </label>
      </div>
    </div>

    <h3><label>Autonomie : </label><label id="autonomie_h"> </label><label>h</label><label id="autonomie_min"> </label></h3>
    <h3><label>Temps de recharge : </label><label id="tpsChargement_h"> </label><label>h</label><label id="tpsChargement_min"> </label></h3>
    <hr>
    <div class="container">                           <!--  Affichage serveur Rest  -->
      <h2> Calculez votre temps de trajet réel </h2>              
      <p></p>
      <form id="f1">
        <h6><label>Temps de trajet (en min) :</label> <input id="tpsTotal" type="number" /> </h6>    
        <input type="submit" id="s1" value="Calculer"/>
      </form>
      <h3><div class="result">Calcul en cours...</div></h3>
    </div>
    <hr>

    <div class="container">                           <!--  Affichage API Rest  -->
      <h2> Trouvez la borne électrique la plus proche de vous </h2>
      <p></p>
      <form id="f2">
        <label>Latitude </label><input id="latitude" step="0.000001" type="number" />
        <label>Longitude </label><input id="longitude" step="0.000001" type="number" />  
        <label>Rayon (en m) </label><input id="rayon" type="number" />  
        <input type="submit" id="s2" value="Rechercher"/>
      </form>
      <h3><div id="name"></div></h3>
      <h3><div id="adress"></div></h3>
      <h3><div id="accessibility"></div></h3>
      <h3><div id="dist"></div></h3>
    </div>
    <p></p>
    <hr>
    <div >                                            <!--  Affichage Map Google  -->
      <div >
          <h2>Recherchez une itinéraire</h1>
          <form class="form-horizontal">
      
            <input type="text" id="from" placeholder="Départ"">
            <input type="text" id="to" placeholder="Arrivée">
             
          </form>
  
          <div class="col-xs-offset-2 col-xs-10">
              <button onclick="calculTrajet();">Rechercher</button>
          </div>
      </div>
      <div class="container-fluid">
          <div id="googleMap"></div>
          <h3><div id="output"></div></h3>
      </div>
  
    </div>

  </header>

  

  
<script src="/socket.io/socket.io.js"></script>
<script>                // SOAP
console.log("JS INIT")
var socket = io();
let jason;
let idSelected;
socket.on('initJson',function(jison){
            jason = jison
            jason = JSON.parse(JSON.stringify(jason))
            console.log("jason = jison")
        })

// Toggle between hiding and showing blog replies/comments
//document.getElementById("myBtn").click();
function myFunction(id) {
  idSelected = id;
  console.log("test", id);
  console.log("jason is :", jason);
  console.log("VOITURE :",jason[id]['autonomie']);
  document.getElementById("autonomie_h").innerHTML = Math.floor(jason[id]['autonomie'] / 60);
  document.getElementById("autonomie_min").innerHTML = jason[id]['autonomie'] % 60;
  document.getElementById("tpsChargement_h").innerHTML = Math.floor(jason[id]['tps_recharge'] / 60);
  if(jason[id]['tps_recharge'] % 60 != 0){
    document.getElementById("tpsChargement_min").innerHTML = jason[id]['tps_recharge'] % 60;
  }
  else{
    document.getElementById("tpsChargement_min").innerHTML = " ";
  }


}
</script>

<script>                // REST
	document.getElementById("f1").addEventListener("submit", sendData);
  function sendData(e) {
    e.preventDefault();
    const autonomie = jason[idSelected]['autonomie']
    const tps_recharge = jason[idSelected]['tps_recharge']
    const tps_total = document.querySelector("#tpsTotal").value;

    fetch("/add", {
        method: "POST",
        headers: {
            Accept: "application/json",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            autonomie: parseInt(autonomie),
            tps_recharge: parseInt(tps_recharge),
            tps_trajet: parseInt(tps_total)
        })
    })
    .then(res => res.json())
    .then(data => {
        const {
            result
        } = data;
        document.querySelector(".result").innerText = `Le temps de trajet sera de: ${ Math.floor(result/60)}h${ result % 60}`;
    })
    .catch(err => console.log(err));
  }
</script>

<script>                // API BORNE
  //let btnS2 = document.querySelector('#s2');
	document.getElementById("f2").addEventListener("submit", askAPI);
  function askAPI(e) {
    e.preventDefault();
    let lat = document.querySelector("#latitude").value;
    let long = document.querySelector("#longitude").value;
    let ray = document.querySelector("#rayon").value;
    const url = "https://opendata.reseaux-energies.fr/api/records/1.0/search/?dataset=bornes-irve&q=&sort=-dist&facet=region&geofilter.distance="+lat+"%2C+"+long+"%2C+"+ray
    var headers = {
      Accept: "application/json"}

    fetch(url, {
        method : "GET",
        mode: 'cors',
        headers: headers
    })
    .then(res => res.json())
    .then(data => {const { result } = data;
        console.log(result);
        console.log(data);
        
        if(data['records'][0] != null){
          document.getElementById("name").innerHTML = ` ${data['records'][0]['fields']['n_station']}`
          document.getElementById("adress").innerHTML = ` ${data['records'][0]['fields']['ad_station']}`
          document.getElementById("accessibility").innerHTML = ` ouvert ${data['records'][0]['fields']['accessibilite']}`
          document.getElementById("dist").innerHTML = `à ${Math.floor(data['records'][0]['fields']['dist'])}m`
        }
        else{
          document.getElementById("adress").innerHTML = `Aucune borne se situe dans le rayon précisé.`
          document.getElementById("name").innerHTML = ` `
          document.getElementById("accessibility").innerHTML = ` `
          document.getElementById("dist").innerHTML = ` `
        }
        
    })
    .catch(err => console.log(err));
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVaGVyav_XYe8b5vjyzGf3C624dBgOJYg&libraries=places"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="Scripts/jquery-3.1.1.min.js"></script>

<script>                // API GOOGLE
  var startPos = { lat: 45.6632765, lng: 5.9131808 };
  var mapOptions = {
      center: startPos,
      zoom: 13,
      mapTypeId: google.maps.MapTypeId.ROADMAP

  };

  //create map
  var map = new google.maps.Map(document.getElementById('googleMap'), mapOptions);
  //create a DirectionsService object to use the route method and get a result for our request
  var directionsService = new google.maps.DirectionsService();
  //create a DirectionsRenderer object which we will use to display the route
  var directionsDisplay = new google.maps.DirectionsRenderer();
  //bind the DirectionsRenderer to the map
  directionsDisplay.setMap(map);


  //define calculTrajet function
  function calculTrajet() {
      //create request
      var request = {
          origin: document.getElementById("from").value,
          destination: document.getElementById("to").value,
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.IMPERIAL
      }

      //pass the request to the route method
      directionsService.route(request, function (result, status) {
          if (status == google.maps.DirectionsStatus.OK) { // Si la requete est bonne

              //Affiche distance et temps 
              const output = document.querySelector('#output');
              output.innerHTML = "Distance à parcourir : "  + Math.floor(result.routes[0].legs[0].distance.value / 1000) + "km."+ "<br> Durée : " + result.routes[0].legs[0].duration.text + ".</br></div>";
              //Affiche Trajet
              directionsDisplay.setDirections(result);
          } else {
              //suppr route
              directionsDisplay.setDirections({ routes: [] });
              
              map.setCenter(startPos);

              output.innerHTML = "<div class='alert-danger'><i class='fas fa-exclamation-triangle'></i> Trajet non réalisable en voiture.</div>";
          }
      });

  }



  //create autocomplete objects for all inputs
  var options = {
      types: ['(cities)']
  }

  var input1 = document.getElementById("from");
  var autocomplete1 = new google.maps.places.Autocomplete(input1, options);

  var input2 = document.getElementById("to");
  var autocomplete2 = new google.maps.places.Autocomplete(input2, options);

</script>

</body>
</html>
